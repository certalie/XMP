const fetch = require('node-fetch');
const { VersionedTransaction, Connection, Keypair } = require('@solana/web3.js');
const fs = require('fs');
const bs58 = require('bs58');

// RPC URL для подключения
const httpRpcUrl = 'https://damp-quaint-season.solana-mainnet.quiknode.pro/a49fc3d8e0698c7e5419b13c129ff7f386f9711f';

// Чтение приватного ключа из файла
const secretKeyString = fs.readFileSync('/home/botadmin/bot-wallet.json', 'utf8');
const secretKey = Uint8Array.from(JSON.parse(secretKeyString));
const botKeypair = Keypair.fromSecretKey(secretKey);

// Публичный ключ кошелька
const publicKey = botKeypair.publicKey.toBase58(); // Генерация публичного ключа из приватного

// Адрес токена
const tokenMint = 'ocNUtraYSnAZ2we83B3cAmLBGRG5XCktZqFs8n4pump';

// Настройка RPC подключения
const web3Connection = new Connection(httpRpcUrl, 'confirmed');

// Параметры транзакции
const transactionParams = {
  publicKey,             // Публичный ключ кошелька
  action: "sell",        // Продажа
  mint: tokenMint,       // Токен
  denominatedInSol: "false", // Сумма в токенах
  amount: "100%",        // Продать весь баланс токена
  slippage: 15,          // Проскальзывание (в процентах)
  priorityFee: 0.00002,  // Приоритетная комиссия
  pool: "pump"           // Пул "radium"
};

// Функция для получения и отправки транзакции
async function sendPortalTransaction() {
  try {
    // Шаг 1: Получение транзакции
    const response = await fetch(`https://pumpportal.fun/api/trade-local`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify(transactionParams)
    });

    if (response.status !== 200) {
      console.error("Ошибка получения транзакции:", response.statusText);
      return;
    }

    const serializedTx = await response.arrayBuffer();
    const tx = VersionedTransaction.deserialize(new Uint8Array(serializedTx));

    // Шаг 2: Подпись транзакции
    tx.sign([botKeypair]);

    // Шаг 3: Отправка транзакции через RPC
    const signature = await web3Connection.sendTransaction(tx);
    console.log(`Транзакция успешно отправлена: https://solscan.io/tx/${signature}`);
  } catch (error) {
    console.error("Ошибка выполнения транзакции:", error);
  }
}

// Запуск функции
sendPortalTransaction();
